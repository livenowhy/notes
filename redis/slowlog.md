## redis慢查询日志

#### 慢查询分析
  
  许多存储系统(如:MySQL)提供慢查询日志帮助开发与运维人员定位系统存在的慢操作.
  所谓慢查询日志就是系统在命令执行前后计算每条命令的执行时间,当超过预设阈值,就将这条命令的相关信息(例如:发生时间,耗时,命令的详细信息)记录到慢查询日志中,Redis也提供了类似的功能.

#### Redis命令执行流程

  ![Fanout redis_showlog](../images/redis/redis_showlog.png)
  
  `1` 发送命令

  `2` 命令排队

  `3` 命令执行

  `4` 返回结果

  需要注意,慢查询只统计步骤3的时间,所以没有慢查询并不代表客户端没有超时问题.
  
  
#### 慢查询的两个配置参数
  
  对于慢查询功能,需要明确两件事:

  `1` 预设阈值怎么设置

  `2` 慢查询记录存放在那
  
    Redis提供了slowlog-log-slower-than和slowlog-max-len配置来解决这两个问题.
    从字面意思就可以看出,slowlog-log-slower-than就是这个预设阈值,它的单位是毫秒(1秒= 1000000 微秒)默认值是10000,
    假如执行了一条"很慢"的命令(例如key *),如果执行时间超过10000微秒,那么它将被记录在慢查询日志中.
    
    如果slowlog-log-slower-than=0会记录所有命令,slowlog-log-slower-than<0对于任何命令都不会进行记录.
    
    从字面意思看,slowlog-max-len只是说明了慢查询日志最多存储多少条,并没有说明存放在哪里?
    实际上Redis使用了一个列表来存储慢查询日志,slowlog-max-len就是列表的最大长度.
    一个新的命令满足慢查询条件时被插入到这个列表中,当慢查询日志列表已处于其最大长度时,最早插入的一个命令将从列表中移出,例如slowlog-max-len设置长度为64.
    当有第65条慢查询日志插入的话,那么队头的第一条数据就出列,第65条慢查询就会入列.
    
    在Redis中有两种修改配置的方法,一种是修改配置文件,另一种是使用 config set 命令动态修改.
    例如下面使用 config set 命令将 slowlog-log-slower-than 设置为20000微妙.slowlog-max-len设置为1024:
    
    config set slowlog-log-slower-than 20000
    config set slowlog-max-len 1024
    config rewrite
    
     
    如果需要将Redis将配置持久化到本地配置文件,要执行 config rewrite 命令.
    
    虽然慢查询日志存放在Redis内存列表中,但是Redis并没有暴露这个列表的键,而是通过一组命令来实现对慢查询日志的访问和管理.
    
    
    
#### 慢查询日志操作

  `1` 获取慢查询日志

    slowlog get [n]      参数n可以指定条数

    8001> slowlog get 10
    1) 1) (integer) 715
       2) (integer) 1546448495
       3) (integer) 29986
       4) 1) "hkeys"
          2) "redis_contract_address"
       5) "172.26.34.62:50832"
       6) ""
       
    可以看到每个查询日志有 4 个属性组成,分别是慢查询日志的表示id、发生时间戳、命令耗时、执行命令和参数。
    
    
  `2` 获取慢查询日志列表当前长度
      
    slowlog len
    例如,当前Redis中有 128 条慢查询:
    127.0.0.1:8001> slowlog len
    (integer) 128


  `3` 慢查询日志重置(实际是对列表做清理操作)

    slowlog reset
    
#### 实践
  
    慢查询功能可以有效地帮助我们找到Redis可能存在的瓶颈,但在实际使用过程中要注意以下几点:

    slowlog-max-len: 线上建议调大慢查询列表,记录慢查询时Redis会对长命令做阶段操作,并不会占用大量内存.
                     增大慢查询列表可以减缓慢查询被剔除的可能,例如线上可设置为1000以上.
                     

    slowlog-log-slower-than: 默认值超过10毫秒判定为慢查询,需要根据Redis并发量调整该值.
                             由于Redis采用单线程相应命令,对于高流量的场景,如果命令执行时间超过1毫秒以上,
                             那么Redis最多可支撑OPS不到1000因此对于高OPS场景下的Redis建议设置为1毫秒.
                             

    慢查询只记录命令的执行时间,并不包括命令排队和网络传输时间.
    因此客户端执行命令的时间会大于命令的实际执行时间.
    因为命令执行排队机制,慢查询会导致其他命令级联阻塞,因此客户端出现请求超时时,需要检查该时间点是否有对应的慢查询,从而分析是否为慢查询导致的命令级联阻塞.


    由于慢查询日志是一个先进先出的队列,也就是说如果慢查询比较多的情况下,可能会丢失部分慢查询命令,为了防止这种情况发生,
    可以定期执行slowlog get命令将慢查询日志持久化到其他存储中(例如:MySQL、ElasticSearch等),然后可以通过可视化工具进行查询.